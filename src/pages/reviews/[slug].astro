---
import { getCollection, render } from "astro:content";
import PaperLayout from "../../layouts/PaperLayout.astro";
import ReviewAudioController, {
  TrackTrigger,
} from "../../components/ReviewAudio.jsx";

export async function getStaticPaths() {
  const reviews = await getCollection("reviews");
  return reviews.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
// Make sure to destructure 'cover' here
const { title, artist, rating, cover, playlist = [] } = entry.data;
const { Content } = await render(entry);
---

<PaperLayout title={`${title} Review`}>
  <div class="max-w-6xl mx-auto px-6 py-12">
    {/* HERO SECTION */}
    <header
      class="mb-16 grid grid-cols-1 md:grid-cols-12 gap-12 items-end border-b-4 border-text pb-12"
    >
      {/* LEFT: TEXT INFO (Span 7) */}
      <div class="md:col-span-7 relative z-10">
        <h1
          class="text-6xl md:text-9xl font-heading italic text-text leading-[0.8] mb-6"
        >
          {title}
        </h1>
        <h2
          class="text-3xl md:text-5xl text-text/80"
          style="font-family: var(--font-marker);"
        >
          {artist}
        </h2>
      </div>

      {/* RIGHT: ALBUM ART + SCORE (Span 5) */}
      <div class="md:col-span-5 relative flex justify-center md:justify-end">
        {/* The Album Cover (Tilted 'Sleeve') */}
        {
          cover && (
            <div class="relative w-full max-w-md aspect-square bg-gray-900 border-4 border-text shadow-[16px_16px_0px_var(--color-primary)] rotate-3 hover:rotate-0 transition-transform duration-500">
              <img
                src={cover.src}
                alt={`${title} Cover`}
                class="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-500"
              />

              {/* OPTIONAL: Vinyl Record peeking out the side */}
              <div class="absolute top-2 bottom-2 -right-4 w-4 bg-black border-r-2 border-y-2 border-text -z-10 rounded-r-lg" />
            </div>
          )
        }

        {/* The Score Stamp (Overlapping the Art) */}
        {
          rating && (
            <div class="absolute -bottom-6 -left-6 md:-left-12 z-20">
              <div class="flex flex-col items-center justify-center w-32 h-32 md:w-40 md:h-40 border-4 border-text rounded-full bg-accent -rotate-12 shadow-[8px_8px_0px_black] group hover:scale-110 transition-transform">
                <span
                  class="text-6xl md:text-7xl text-black leading-none mt-2"
                  style="font-family: var(--font-marker);"
                >
                  {rating}
                </span>
              </div>
            </div>
          )
        }
      </div>
    </header>

    {/* AUDIO PLAYER + CONTENT */}
    <ReviewAudioController client:load playlist={playlist}>
      <div class="prose prose-xl prose-invert max-w-none font-body">
        <Content components={{ TrackTrigger }} />
      </div>
    </ReviewAudioController>
  </div>
</PaperLayout>
